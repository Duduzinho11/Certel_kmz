<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rede Certel</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM (Estilo iOS) --- */
        :root {
            --primary: #0044CC; /* Azul Certel mais vibrante */
            --success: #34C759; /* Verde iOS */
            --bg: #F2F2F7;      /* Fundo iOS */
            --card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- TELA DE LOGIN (Glassmorphism) --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0044CC 0%, #002a80 100%);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 24px;
            width: 80%; max-width: 320px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-logo { font-size: 40px; margin-bottom: 10px; }
        .login-title { color: white; font-size: 20px; font-weight: 700; margin-bottom: 5px; letter-spacing: 0.5px; }
        .login-sub { color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 20px; }

        .input-ios {
            width: 100%; padding: 16px; border-radius: 14px;
            border: none; background: rgba(255,255,255,0.9);
            font-size: 17px; text-align: center; margin-bottom: 15px;
            box-sizing: border-box; outline: none;
        }

        .btn-ios-primary {
            width: 100%; padding: 16px; border-radius: 14px;
            border: none; background: var(--success);
            color: white; font-size: 17px; font-weight: 600;
            cursor: pointer; transition: transform 0.1s;
        }
        .btn-ios-primary:active { transform: scale(0.96); opacity: 0.9; }

        /* --- APP PRINCIPAL --- */
        #app-content { display: none; padding-bottom: 40px; }

        .header {
            background: var(--card);
            padding: 50px 20px 15px 20px; /* Topo maior para ignorar o notch do iPhone */
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 { margin: 0; font-size: 22px; color: var(--primary); }
        .header p { margin: 5px 0 0 0; font-size: 13px; color: var(--text-sub); }

        .container { padding: 0 20px; }

        /* Status Card */
        .status-card {
            background: var(--card); border-radius: 20px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px;
            text-align: center;
        }

        .status-badge {
            background: #E8F2FF; color: var(--primary);
            padding: 6px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            display: inline-block; margin-bottom: 10px;
        }

        .import-area {
            border: 2px dashed #D1D1D6; border-radius: 16px;
            padding: 25px; margin-top: 15px; position: relative;
            background: #FAFAFC; transition: 0.2s;
        }
        .import-area:active { background: #E5E5EA; }
        
        #file-input { display: none; }
        
        .import-label {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            color: var(--primary); font-weight: 600; font-size: 15px;
        }

        /* Grid de Menu */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .menu-btn {
            background: var(--card); border: none; padding: 20px;
            border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            font-size: 14px; font-weight: 600; color: var(--text-main);
            transition: 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); background: #F2F2F7; }
        .menu-icon { font-size: 28px; }

        /* Lista */
        .search-bar {
            position: sticky; top: 10px; z-index: 100;
            margin: 0 20px 15px 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .search-input {
            width: 100%; padding: 14px 20px; border: none;
            background: transparent; font-size: 16px; outline: none;
        }

        .list-container { padding: 0 20px; }
        
        .list-item {
            background: var(--card); padding: 16px; margin-bottom: 10px;
            border-radius: 16px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        
        .item-info b { display: block; font-size: 16px; margin-bottom: 4px; }
        .item-info span { font-size: 13px; color: var(--text-sub); }

        .btn-nav {
            background: #E8F2FF; color: var(--primary);
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; border: none; cursor: pointer;
        }

        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #E5E5EA;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo">‚ö°</div>
            <div class="login-title">Rede Certel</div>
            <div class="login-sub">Acesso T√©cnico</div>
            
            <input type="password" id="senha-input" class="input-ios" placeholder="Senha da Equipe">
            <button class="btn-ios-primary" onclick="tentarLogin()">Entrar</button>
            <div id="erro-msg" style="color: #ffcccb; font-size: 13px; margin-top: 15px; display: none;">Senha incorreta</div>
        </div>
    </div>

    <div id="app-content">
        
        <div class="header">
            <h1>Rede Certel</h1>
            <p>Consulta de Ativos Offline</p>
        </div>

        <div id="loader" class="loader-overlay">
            <div class="spinner"></div>
            <div style="font-weight: 600; color: var(--text-main);">Processando Arquivo...</div>
            <div style="font-size: 13px; color: var(--text-sub); margin-top: 5px;">Isso pode levar at√© 1 minuto.</div>
        </div>

        <div id="view-home" class="container">
            
            <div class="status-card">
                <span class="status-badge">Base de Dados</span>
                <div id="status-text" style="font-size: 24px; font-weight: 700; color: var(--primary); margin: 10px 0;">
                    Vazia
                </div>
                <div id="status-sub" style="font-size: 13px; color: var(--text-sub);">
                    Nenhum arquivo carregado
                </div>

                <label class="import-area">
                    <input type="file" id="file-input" accept=".kml,.kmz" onchange="processarArquivo(this)">
                    <div class="import-label">
                        <span style="font-size: 24px;">üìÇ</span>
                        <span>Abrir Arquivo da Rede</span>
                        <span style="font-size: 11px; color: #8E8E93; font-weight: 400;">Suporta .KMZ e .KML (80MB+)</span>
                    </div>
                </label>

                <div onclick="resetarApp()" style="margin-top: 15px; font-size: 12px; color: #FF3B30; cursor: pointer;">
                    Limpar dados e Sair
                </div>
            </div>

            <div class="grid-menu">
                <button class="menu-btn" onclick="abrirCategoria('TR')">
                    <span class="menu-icon">‚ö°</span>
                    Transformador
                </button>
                <button class="menu-btn" onclick="abrirCategoria('CH')">
                    <span class="menu-icon">üîò</span>
                    Chave
                </button>
                <button class="menu-btn" style="grid-column: span 2; flex-direction: row; justify-content: center;" onclick="abrirCategoria('UC')">
                    <span class="menu-icon">üë§</span>
                    Clientes (UC)
                </button>
            </div>
        </div>

        <div id="view-lista" style="display: none;">
            <div class="search-bar">
                <input type="text" id="busca" class="search-input" placeholder="Buscar..." onkeyup="filtrar()">
            </div>
            
            <div style="padding: 0 20px 10px 20px; display: flex; align-items: center; gap: 10px;">
                <button onclick="voltar()" style="background: none; border: none; font-size: 16px; color: var(--primary); font-weight: 600;">‚Üê Voltar</button>
                <span id="titulo-cat" style="font-weight: 700; font-size: 18px; margin-left: auto;">Lista</span>
            </div>

            <div id="lista-container" class="list-container"></div>
        </div>

    </div>

<script>
    // --- CONFIGURA√á√ÉO ---
    const SENHA_ACESSO = "certel2024"; 
    let dbAtivos = [];
    let filtroAtual = "";

    // --- 1. AUTENTICA√á√ÉO ---
    function tentarLogin() {
        const pass = document.getElementById('senha-input').value;
        if(pass === SENHA_ACESSO) {
            localStorage.setItem('auth_token', 'ok');
            iniciarSistema();
        } else {
            document.getElementById('erro-msg').style.display = 'block';
        }
    }

    function iniciarSistema() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        carregarDoBanco();
    }

    if(localStorage.getItem('auth_token') === 'ok') {
        iniciarSistema();
    }

    // --- 2. BANCO DE DADOS (LocalForage) ---
    async function carregarDoBanco() {
        localforage.config({ name: 'CertelApp', storeName: 'ativos' });
        
        const total = await localforage.getItem('total');
        const data = await localforage.getItem('data_importacao');

        if(total && total > 0) {
            atualizarStatus(total, data);
            // Carrega em background para n√£o travar anima√ß√£o
            setTimeout(async () => {
                dbAtivos = await localforage.getItem('lista') || [];
            }, 300);
        }
    }

    function atualizarStatus(qtd, data) {
        document.getElementById('status-text').innerText = parseInt(qtd).toLocaleString();
        document.getElementById('status-text').style.color = "var(--success)";
        document.getElementById('status-sub').innerText = "Atualizado em: " + data;
    }

    // --- 3. PROCESSAMENTO DE ARQUIVO (ENGINE) ---
    async function processarArquivo(input) {
        const file = input.files[0];
        if(!file) return;

        mostrarLoader(true);

        try {
            let texto = "";
            
            // Verifica se √© KMZ (Zip)
            if(file.name.toLowerCase().endsWith(".kmz")) {
                const zip = await JSZip.loadAsync(file);
                const kmlName = Object.keys(zip.files).find(n => n.toLowerCase().endsWith(".kml"));
                if(!kmlName) throw new Error("Arquivo KML n√£o encontrado dentro do KMZ");
                texto = await zip.files[kmlName].async("string");
            } else {
                texto = await file.text();
            }

            // Limpa namespaces para facilitar
            texto = texto.replace(/<(\w+):/g, "<").replace(/<\/(\w+):/g, "</");

            // Inicia Scanner
            setTimeout(() => executarScanner(texto), 100);

        } catch(e) {
            alert("Erro ao ler arquivo: " + e.message);
            mostrarLoader(false);
        }
        input.value = ""; // Reseta input
    }

    async function executarScanner(xml) {
        try {
            const novos = [];
            let cursor = 0;

            while(true) {
                const inicio = xml.indexOf("<Placemark", cursor);
                if(inicio === -1) break;
                
                const fim = xml.indexOf("</Placemark>", inicio);
                if(fim === -1) break;

                const bloco = xml.substring(inicio, fim);
                
                // Regex super r√°pida local
                const matchNome = bloco.match(/<name[\s\S]*?>([\s\S]*?)<\/name>/i);
                const matchCoord = bloco.match(/<coordinates[\s\S]*?>([\s\S]*?)<\/coordinates>/i);

                if(matchNome && matchCoord) {
                    let nome = matchNome[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                    let coordRaw = matchCoord[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                    
                    // Pega primeira coordenada v√°lida
                    const coordPair = coordRaw.split(/\s+/)[0].split(',');
                    
                    if(coordPair.length >= 2) {
                        novos.push({ n: nome, lat: coordPair[1], lng: coordPair[0] });
                    }
                }
                cursor = fim + 12;
            }

            if(novos.length === 0) throw new Error("Nenhum dado encontrado.");

            // Salva
            const hoje = new Date().toLocaleDateString('pt-BR');
            await localforage.setItem('lista', novos);
            await localforage.setItem('total', novos.length);
            await localforage.setItem('data_importacao', hoje);

            dbAtivos = novos;
            atualizarStatus(novos.length, hoje);
            mostrarLoader(false);
            alert("Sucesso! " + novos.length + " pontos importados.");

        } catch(e) {
            console.error(e);
            alert("Erro no processamento: " + e.message);
            mostrarLoader(false);
        }
    }

    // --- 4. LISTAGEM E NAVEGA√á√ÉO ---
    function abrirCategoria(tipo) {
        if(dbAtivos.length === 0) {
            alert("Importe o arquivo primeiro!");
            return;
        }
        filtroAtual = tipo;
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-lista').style.display = 'block';
        document.getElementById('titulo-cat').innerText = tipo === 'UC' ? 'Clientes' : tipo;
        document.getElementById('busca').value = "";
        filtrar();
    }

    function filtrar() {
        const termo = document.getElementById('busca').value.toLowerCase();
        const container = document.getElementById('lista-container');
        container.innerHTML = "";

        // Filtra e pega top 50
        const resultados = dbAtivos.filter(item => {
            const nome = item.n.toUpperCase();
            let tipoOk = false;
            
            if(filtroAtual === 'TR') tipoOk = nome.includes("TR");
            else if(filtroAtual === 'CH') tipoOk = nome.includes("CH") || nome.includes("SECCIONADORA");
            else if(filtroAtual === 'UC') tipoOk = !nome.includes("TR") && !nome.includes("CH");

            return tipoOk && (termo === "" || item.n.toLowerCase().includes(termo));
        }).slice(0, 50);

        if(resultados.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#8E8E93;'>Nenhum resultado</div>";
            return;
        }

        resultados.forEach(item => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="item-info">
                    <b>${item.n}</b>
                    <span>${parseFloat(item.lat).toFixed(5)}, ${parseFloat(item.lng).toFixed(5)}</span>
                </div>
                <button class="btn-nav" onclick="abrirMapa('${item.lat}', '${item.lng}')">‚û§</button>
            `;
            container.appendChild(div);
        });
    }

    function abrirMapa(lat, lng) {
        // Abre Apple Maps no iPhone ou Google Maps no Android
        window.open(`maps://?q=${lat},${lng}`, '_system');
    }

    function voltar() {
        document.getElementById('view-lista').style.display = 'none';
        document.getElementById('view-home').style.display = 'block';
    }

    function mostrarLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    async function resetarApp() {
        if(confirm("Deseja apagar os dados e sair?")) {
            await localforage.clear();
            localStorage.removeItem('auth_token');
            location.reload();
        }
    }

</script>

<link rel="manifest" href="manifest.json">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
</script>

</body>
</html>
