<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rede Certel</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM (iOS Clean) --- */
        :root {
            --primary: #0044CC;
            --success: #34C759;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- LAYOUT PRINCIPAL --- */
        #app-content { display: block; padding-bottom: 40px; }

        .header {
            background: var(--card);
            padding: 50px 20px 15px 20px; /* Topo maior para o notch */
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 22px; color: var(--primary); letter-spacing: -0.5px; }
        .header p { margin: 5px 0 0 0; font-size: 13px; color: var(--text-sub); }

        .container { padding: 0 20px; }

        /* CARD DE STATUS */
        .status-card {
            background: var(--card); border-radius: 20px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
            text-align: center;
        }

        /* BOT√ÉO DE IMPORTAR (CORRIGIDO E BONITO) */
        .import-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #F5F7FA;
            border: 2px dashed #0044CC;
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box; /* Garante que n√£o estoure a tela */
        }
        
        .import-area:active { transform: scale(0.98); background-color: #E8F0FE; }

        .import-icon { font-size: 36px; margin-bottom: 10px; }
        .import-text { color: var(--primary); font-weight: 700; font-size: 16px; }
        .import-sub { font-size: 12px; color: var(--text-sub); margin-top: 5px; }
        
        #file-input { display: none; }

        /* GRID DE MENU */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .menu-btn {
            background: var(--card); border: none; padding: 20px;
            border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            font-size: 15px; font-weight: 600; color: var(--text-main);
            transition: 0.2s;
        }
        .menu-btn:active { transform: scale(0.96); background: #E5E5EA; }
        .menu-icon { font-size: 28px; }

        /* LISTA */
        .search-bar {
            position: sticky; top: 0; z-index: 100;
            padding: 10px 20px 15px 20px;
            background: rgba(242, 242, 247, 0.95); /* Cor do fundo com blur */
            backdrop-filter: blur(10px);
        }
        
        .search-input {
            width: 100%; padding: 14px 20px; border: none;
            background: #E3E3E8; border-radius: 12px;
            font-size: 16px; outline: none; color: var(--text-main);
            box-sizing: border-box;
        }

        .list-container { padding: 0 20px; }
        
        .list-item {
            background: var(--card); padding: 18px; margin-bottom: 12px;
            border-radius: 16px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .item-info b { display: block; font-size: 17px; margin-bottom: 4px; color: var(--text-main); }
        .item-info span { font-size: 13px; color: var(--text-sub); }

        .btn-nav {
            background: #E8F2FF; color: var(--primary);
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border: none; cursor: pointer;
        }

        /* LOADER */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #E5E5EA;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app-content">
        
        <div class="header">
            <h1>Rede Certel</h1>
            <p>Mapa de Ativos Offline</p>
        </div>

        <div id="loader" class="loader-overlay">
            <div class="spinner"></div>
            <div style="font-weight: 600; color: var(--text-main);">Processando...</div>
            <div style="font-size: 13px; color: var(--text-sub); margin-top: 5px;">Aguarde alguns segundos.</div>
        </div>

        <div id="view-home" class="container">
            
            <div class="status-card">
                <div style="font-size: 12px; color: #8E8E93; text-transform: uppercase; font-weight: 600;">Status da Base</div>
                <div id="status-text" style="font-size: 26px; font-weight: 700; color: var(--text-main); margin: 6px 0;">Vazia</div>
                <div id="status-sub" style="font-size: 14px; color: var(--text-sub); margin-bottom: 15px;">Nenhum dado</div>

                <label for="file-input" class="import-area">
                    <span class="import-icon">üìÇ</span>
                    <span class="import-text">Abrir Arquivo da Rede</span>
                    <span class="import-sub">Toque aqui para selecionar o KMZ/KML</span>
                </label>
                <input type="file" id="file-input" accept=".kml,.kmz" onchange="processarArquivo(this)">

                <div onclick="resetarApp()" style="margin-top: 25px; font-size: 13px; color: var(--danger); cursor: pointer; font-weight: 500;">
                    üóëÔ∏è Limpar dados e Resetar
                </div>
            </div>

            <div class="grid-menu">
                <button class="menu-btn" onclick="abrirCategoria('TR')">
                    <span class="menu-icon">‚ö°</span>
                    Transformador
                </button>
                <button class="menu-btn" onclick="abrirCategoria('CH')">
                    <span class="menu-icon">üîò</span>
                    Chave
                </button>
                <button class="menu-btn" style="grid-column: span 2; flex-direction: row; justify-content: center;" onclick="abrirCategoria('UC')">
                    <span class="menu-icon">üë§</span>
                    Clientes (UC)
                </button>
            </div>
        </div>

        <div id="view-lista" style="display: none;">
            <div class="search-bar">
                <input type="text" id="busca" class="search-input" placeholder="Buscar..." onkeyup="filtrar()">
            </div>
            
            <div style="padding: 0 20px 10px 20px; display: flex; align-items: center; gap: 10px;">
                <button onclick="voltar()" style="background: none; border: none; font-size: 17px; color: var(--primary); font-weight: 600;">‚Üê Voltar</button>
                <span id="titulo-cat" style="font-weight: 700; font-size: 20px; margin-left: auto; color: var(--text-main);">Lista</span>
            </div>

            <div id="lista-container" class="list-container"></div>
        </div>

    </div>

<script>
    let dbAtivos = [];
    let filtroAtual = "";

    // --- 1. INICIALIZA√á√ÉO AUTOM√ÅTICA (Sem Login) ---
    window.onload = () => {
        carregarDoBanco();
    };

    async function carregarDoBanco() {
        localforage.config({ name: 'CertelApp', storeName: 'ativos' });
        
        try {
            const total = await localforage.getItem('total');
            const data = await localforage.getItem('data_importacao');

            if(total && total > 0) {
                atualizarStatus(total, data);
                // Carrega em background
                setTimeout(async () => {
                    dbAtivos = await localforage.getItem('lista') || [];
                }, 200);
            }
        } catch (e) {
            console.log("Banco vazio ou erro:", e);
        }
    }

    function atualizarStatus(qtd, data) {
        const elText = document.getElementById('status-text');
        const elSub = document.getElementById('status-sub');
        
        elText.innerText = parseInt(qtd).toLocaleString();
        elText.style.color = "var(--success)";
        elSub.innerText = "Atualizado em: " + data;
    }

    // --- 2. PROCESSAMENTO (Engine) ---
    async function processarArquivo(input) {
        const file = input.files[0];
        if(!file) return;

        mostrarLoader(true);

        try {
            let texto = "";
            
            // Suporte a KMZ (Zip)
            if(file.name.toLowerCase().endsWith(".kmz")) {
                const zip = await JSZip.loadAsync(file);
                const kmlName = Object.keys(zip.files).find(n => n.toLowerCase().endsWith(".kml"));
                if(!kmlName) throw new Error("KML n√£o encontrado no ZIP");
                texto = await zip.files[kmlName].async("string");
            } else {
                texto = await file.text();
            }

            // Limpa sufixos de namespace para facilitar o regex
            texto = texto.replace(/<(\w+):/g, "<").replace(/<\/(\w+):/g, "</");

            // Roda o Scanner
            setTimeout(() => executarScanner(texto), 100);

        } catch(e) {
            alert("Erro ao ler arquivo: " + e.message);
            mostrarLoader(false);
        }
        input.value = ""; // Reseta o input para permitir selecionar o mesmo arquivo
    }

    async function executarScanner(xml) {
        try {
            const novos = [];
            let cursor = 0;

            while(true) {
                const inicio = xml.indexOf("<Placemark", cursor);
                if(inicio === -1) break;
                
                const fim = xml.indexOf("</Placemark>", inicio);
                if(fim === -1) break;

                const bloco = xml.substring(inicio, fim);
                
                const matchNome = bloco.match(/<name[\s\S]*?>([\s\S]*?)<\/name>/i);
                const matchCoord = bloco.match(/<coordinates[\s\S]*?>([\s\S]*?)<\/coordinates>/i);

                if(matchNome && matchCoord) {
                    let nome = matchNome[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                    let coordRaw = matchCoord[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                    
                    // Pega primeira coordenada
                    const coordPair = coordRaw.split(/\s+/)[0].split(',');
                    
                    if(coordPair.length >= 2) {
                        novos.push({ n: nome, lat: coordPair[1], lng: coordPair[0] });
                    }
                }
                cursor = fim + 12;
            }

            if(novos.length === 0) throw new Error("Nenhum dado encontrado.");

            const hoje = new Date().toLocaleDateString('pt-BR');
            
            // Salva no IndexedDB
            await localforage.setItem('lista', novos);
            await localforage.setItem('total', novos.length);
            await localforage.setItem('data_importacao', hoje);

            dbAtivos = novos;
            atualizarStatus(novos.length, hoje);
            mostrarLoader(false);
            alert("Sucesso! Base importada.");

        } catch(e) {
            console.error(e);
            alert("Erro no processamento: " + e.message);
            mostrarLoader(false);
        }
    }

    // --- 3. UI E NAVEGA√á√ÉO ---
    function abrirCategoria(tipo) {
        if(dbAtivos.length === 0) {
            alert("Por favor, abra o arquivo da rede primeiro.");
            return;
        }
        filtroAtual = tipo;
        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-lista').style.display = 'block';
        document.getElementById('titulo-cat').innerText = tipo === 'UC' ? 'Clientes' : tipo;
        document.getElementById('busca').value = "";
        filtrar();
    }

    function filtrar() {
        const termo = document.getElementById('busca').value.toLowerCase();
        const container = document.getElementById('lista-container');
        container.innerHTML = "";

        // Filtra e limita a 50 para performance
        const resultados = dbAtivos.filter(item => {
            const nome = item.n.toUpperCase();
            let tipoOk = false;
            
            if(filtroAtual === 'TR') tipoOk = nome.includes("TR");
            else if(filtroAtual === 'CH') tipoOk = nome.includes("CH") || nome.includes("SECCIONADORA");
            else if(filtroAtual === 'UC') tipoOk = !nome.includes("TR") && !nome.includes("CH");

            return tipoOk && (termo === "" || item.n.toLowerCase().includes(termo));
        }).slice(0, 50);

        if(resultados.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:30px; color:#8E8E93;'>Nenhum resultado encontrado</div>";
            return;
        }

        resultados.forEach(item => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="item-info">
                    <b>${item.n}</b>
                    <span>${parseFloat(item.lat).toFixed(5)}, ${parseFloat(item.lng).toFixed(5)}</span>
                </div>
                <button class="btn-nav" onclick="abrirMapa('${item.lat}', '${item.lng}')">‚û§</button>
            `;
            container.appendChild(div);
        });
    }

    function abrirMapa(lat, lng) {
        // Detecta se √© iOS (iPhone/iPad)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        if (isIOS) {
            // Abre Apple Maps
            window.open(`maps://?q=${lat},${lng}`, '_system');
        } else {
            // Abre Google Maps (Android/PC)
            window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, '_system');
        }
    }

    function voltar() {
        document.getElementById('view-lista').style.display = 'none';
        document.getElementById('view-home').style.display = 'block';
    }

    function mostrarLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    async function resetarApp() {
        if(confirm("Deseja realmente apagar a base de dados?")) {
            await localforage.clear();
            location.reload();
        }
    }
</script>

<link rel="manifest" href="manifest.json">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
</script>

</body>
</html>
