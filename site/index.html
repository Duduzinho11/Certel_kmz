<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rede Certel Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        /* (Todo o CSS anterior continua igual) */
        :root { --azul: #003399; --verde: #009933; --cinza: #f4f7f9; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--cinza); color: #333; -webkit-tap-highlight-color: transparent; }
        
        #app-content { display: none; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; width: 80%; max-width: 300px; }
        .login-input { padding: 15px; border-radius: 8px; border: none; width: 100%; margin: 15px 0; font-size: 18px; text-align: center; }
        .btn-login { background: var(--verde); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }

        .app-bar { background: var(--azul); color: white; padding: 18px; text-align: center; font-weight: bold; font-size: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .container { padding: 12px; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; height: 55px; font-size: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .btn-outline { background: white; border: 2px solid var(--azul); color: var(--azul); }
        .btn-menu { height: 80px; flex-direction: column; gap: 5px; font-size: 14px; }
        #input-arquivo { display: none; }
        .file-label { display: flex; align-items: center; justify-content: center; background: #eee; color: #555; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; border: 2px dashed #ccc; text-align: center; }
        input[type="text"] { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
        .item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .btn-go { background: var(--verde); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; }
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--azul); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>ACESSO RESTRITO</h2>
        <p>Digite a senha da equipe</p>
        <input type="password" id="senha" class="login-input" placeholder="Senha">
        <button class="btn-login" onclick="verificarSenha()">ENTRAR</button>
        <p id="msg-erro" style="color: #ffcccc; margin-top: 10px; display: none;">Senha incorreta!</p>
    </div>
</div>

<div id="app-content">
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p id="msg-loader" style="margin-top:20px; font-weight:bold; color:var(--azul);">Lendo...</p>
        <p id="msg-sub" style="font-size:13px; color:#666; margin-top:5px;">N√£o saia desta tela.</p>
    </div>

    <div id="tela-home">
        <div class="app-bar">REDE CERTEL</div>
        <div class="container">
            <div class="card">
                <div style="text-align: center; color: #888; font-size: 12px; text-transform: uppercase;">Base de Dados</div>
                <div id="txt-versao" style="text-align: center; font-weight: bold; color: var(--azul); font-size: 20px; margin: 8px 0;">Aguardando Arquivo...</div>
                <div id="txt-qtd" style="text-align: center; font-size: 13px; color: var(--verde); margin-bottom: 15px;"></div>

                <div style="background:#eef; padding:10px; border-radius:8px; font-size:13px; margin-bottom:15px; color:#446;">
                    ‚ÑπÔ∏è <b>Como atualizar:</b><br>
                    1. Receba o arquivo da rede no WhatsApp.<br>
                    2. Salve em "Arquivos" no iPhone.<br>
                    3. Clique no bot√£o abaixo e selecione ele.
                </div>

                <label for="input-arquivo" class="file-label" style="background: var(--azul); color: white; border: none;">
                    üìÇ IMPORTAR ARQUIVO DA REDE
                </label>
                <input type="file" id="input-arquivo" accept=".kml,.kmz" onchange="processarArquivo(this)">
                
                <br>
                <small style="display:block; text-align:center; color:#999; cursor:pointer;" onclick="limparTudo()">‚ö†Ô∏è Limpar Dados</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-menu btn-outline" onclick="abrirLista('TR')">‚ö° <b>TRANSFORMADOR</b></button>
                <button class="btn btn-menu btn-outline" onclick="abrirLista('CH')">üîò <b>CHAVE</b></button>
                <button class="btn btn-menu btn-outline" style="grid-column: span 2;" onclick="abrirLista('UC')">üë§ <b>CLIENTES (UC)</b></button>
            </div>
        </div>
    </div>

    <div id="tela-lista" style="display:none;">
        <div class="app-bar" style="display: flex; align-items: center; justify-content: center;">
            <span onclick="voltarHome()" style="position: absolute; left: 15px; font-size: 24px; cursor: pointer;">‚¨Ö</span>
            <span id="titulo-lista">Lista</span>
        </div>
        <div class="container" style="padding-top: 0;">
            <div class="card" style="margin-top: 15px; padding: 10px;">
                <input type="text" id="campo-busca" placeholder="Digite..." onkeyup="filtrarLista()">
                <div id="lista-resultados"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUTENTICA√á√ÉO ---
    function verificarSenha() {
        const input = document.getElementById('senha').value;
        if(input === 'certel2024') { // Mude sua senha aqui
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            localStorage.setItem('auth', 'true');
        } else {
            document.getElementById('msg-erro').style.display = 'block';
        }
    }

    if(localStorage.getItem('auth') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
    }

    // --- SISTEMA (Sem FILE_ID) ---
    let dbAtivos = []; 

    window.onload = async () => {
        if(localStorage.getItem('auth') !== 'true') return;

        localforage.config({ name: 'CertelApp', storeName: 'ativos_db' });
        const qtd = await localforage.getItem('total_ativos');
        const ver = await localforage.getItem('versao_base');

        if (qtd && qtd > 0) {
            document.getElementById('txt-versao').innerText = ver;
            document.getElementById('txt-qtd').innerText = `‚úÖ ${parseInt(qtd).toLocaleString()} ativos`;
            setTimeout(async () => { dbAtivos = await localforage.getItem('lista_completa') || []; }, 500);
        } else {
            document.getElementById('txt-versao').innerText = "Nenhuma base carregada";
            document.getElementById('txt-qtd').innerText = "Importe o arquivo para come√ßar.";
        }
    };

    // Fun√ß√£o de Download removida por seguran√ßa. Agora √© s√≥ Importa√ß√£o.

    async function processarArquivo(input) {
        const arquivo = input.files[0];
        if (!arquivo) return;
        showLoader(true, "Lendo arquivo...");
        try {
            let textoKml = "";
            if (arquivo.name.toLowerCase().endsWith(".kmz")) {
                showLoader(true, "Descompactando...");
                const zip = await JSZip.loadAsync(arquivo);
                const kmlFile = Object.keys(zip.files).find(f => f.toLowerCase().endsWith(".kml"));
                if (!kmlFile) throw new Error("KML inv√°lido.");
                textoKml = await zip.files[kmlFile].async("string");
            } else {
                textoKml = await arquivo.text();
            }
            textoKml = textoKml.replace(/<(\w+):/g, "<").replace(/<\/(\w+):/g, "</");
            extrairDadosScanner(textoKml);
        } catch (e) {
            alert("Erro: " + e.message);
            showLoader(false);
        }
        input.value = ""; 
    }

    async function extrairDadosScanner(xml) {
        showLoader(true, "Processando dados...");
        document.getElementById('msg-sub').innerText = "Aguarde o processamento...";
        setTimeout(async () => {
            try {
                const novosAtivos = [];
                let cursor = 0;
                while (true) {
                    const inicioTag = xml.indexOf("<Placemark", cursor);
                    if (inicioTag === -1) break;
                    const fimTag = xml.indexOf("</Placemark>", inicioTag);
                    if (fimTag === -1) break;
                    const conteudo = xml.substring(inicioTag, fimTag);
                    const matchNome = conteudo.match(/<name[\s\S]*?>([\s\S]*?)<\/name>/i);
                    const matchCoord = conteudo.match(/<coordinates[\s\S]*?>([\s\S]*?)<\/coordinates>/i);
                    if (matchNome && matchCoord) {
                        let nomeLimpo = matchNome[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                        let coordLimpa = matchCoord[1].replace(/<!\[CDATA\[|\]\]>/g, "").trim();
                        const primeiraCoord = coordLimpa.trim().split(/\s+/)[0]; 
                        const c = primeiraCoord.split(',');
                        if (c.length >= 2) novosAtivos.push({ n: nomeLimpo, lat: c[1], lng: c[0] });
                    }
                    cursor = fimTag + 12;
                }
                if (novosAtivos.length === 0) throw new Error("Arquivo vazio ou inv√°lido.");
                
                await localforage.setItem('lista_completa', novosAtivos);
                await localforage.setItem('total_ativos', novosAtivos.length);
                const data = new Date().toLocaleDateString();
                await localforage.setItem('versao_base', "Base " + data);
                
                dbAtivos = novosAtivos;
                document.getElementById('txt-versao').innerText = "Base " + data;
                document.getElementById('txt-qtd').innerText = `‚úÖ ${novosAtivos.length.toLocaleString()} ativos`;
                showLoader(false);
                alert("SUCESSO! Base carregada.");
            } catch (e) {
                console.error(e);
                alert("Erro: " + e.message);
                showLoader(false);
            }
        }, 200);
    }

    function abrirLista(tipo) {
        if (dbAtivos.length === 0) { alert("Nenhum dado! Importe o arquivo."); return; }
        filtroTipo = tipo;
        document.getElementById('tela-home').style.display = 'none';
        document.getElementById('tela-lista').style.display = 'block';
        document.getElementById('titulo-lista').innerText = tipo === 'UC' ? 'Clientes' : tipo;
        document.getElementById('campo-busca').value = "";
        filtrarLista();
    }

    function filtrarLista() {
        const termo = document.getElementById('campo-busca').value.toLowerCase();
        const divLista = document.getElementById('lista-resultados');
        divLista.innerHTML = "";
        const resultados = dbAtivos.filter(item => {
            const nome = item.n.toUpperCase();
            let correspondeTipo = false;
            if (filtroTipo === 'TR') correspondeTipo = nome.includes("TR");
            else if (filtroTipo === 'CH') correspondeTipo = nome.includes("CH") || nome.includes("SECCIONADORA");
            else if (filtroTipo === 'UC') correspondeTipo = !nome.includes("TR") && !nome.includes("CH");
            return correspondeTipo && (termo === "" || item.n.toLowerCase().includes(termo));
        }).slice(0, 50);

        if (resultados.length === 0) {
            divLista.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>Nada encontrado.</div>";
            return;
        }

        resultados.forEach(p => {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `<div><div style="font-weight:bold; font-size:16px;">${p.n}</div><div style="font-size:13px; color:#666;">${p.lat}, ${p.lng}</div></div><button class="btn-go" onclick="window.open('maps://?q=' + '${p.lat}' + ',' + '${p.lng}')">‚û§</button>`;
            divLista.appendChild(el);
        });
    }

    async function limparTudo() {
        if(confirm("Apagar base de dados?")) { await localforage.clear(); localStorage.removeItem('auth'); location.reload(); }
    }
    function voltarHome() { document.getElementById('tela-home').style.display = 'block'; document.getElementById('tela-lista').style.display = 'none'; }
    function showLoader(ativo, msg) { document.getElementById('loader').style.display = ativo ? 'flex' : 'none'; if(msg) document.getElementById('msg-loader').innerText = msg; }
</script>

<link rel="manifest" href="manifest.json">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
</script>
</body>
</html>
